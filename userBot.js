const TelegramBot = require('node-telegram-bot-api');
const mongoose = require('mongoose');
const User = require('./models/User');
// ... (بقية الاستيرادات)

// **************************************************
// 1. الإعدادات والتهيئة
// **************************************************
const token = '8294794453:AAHDM0ujjbKZrJsA53Oh844Rfa8BxCwTAGc'; 

// يجب أن يكون التعريف والتنفيذ في هذا المكان
const bot = new TelegramBot(token, { polling: true }); 

// ... (بقية المتغيرات والقوائم) ...

// **************************************************
// 2. دوال المساعدة (Helpers)
// **************************************************
// ... (دالة getOrCreateUser) ...

// **************************************************
// 3. المشغلات (LISTENERS)
// **************************************************

// دالة /start (التي أبلغت عن الخطأ)
bot.onText(/\/start/, async (msg) => {
    // ... (بقية المنطق) ...
});

// ... (بقية onText و on('message') و on('callback_query')) ...

// **************************************************
// 4. تصدير البوت (لـ server.js)
// **************************************************
module.exports = bot; // هذا يضمن إتاحة نسخة البوت للتشغيل
